<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accessibility Scanner</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }
        h1, h2 {
            color: #2c3e50;
        }
        #scanForm {
            margin-bottom: 20px;
        }
        #urlInput {
            width: 70%;
            padding: 8px;
            font-size: 16px;
        }
        button {
            padding: 8px 15px;
            font-size: 16px;
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #2980b9;
        }
        #results {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .summary {
            display: flex;
            justify-content: space-around;
            align-items: center;
            font-size: 1.2em;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #ecf0f1;
            border-radius: 5px;
        }
        .summary-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .summary-count {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2196F3;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .issue {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
        }
        .error {
            border-left: 5px solid #e74c3c;
            background-color: #fadbd8;
        }
        .warning {
            border-left: 5px solid #f39c12;
            background-color: #fef9e7;
        }
        .notice {
            border-left: 5px solid #3498db;
            background-color: #ebf5fb;
        }
        .issue-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .issue-details {
            font-family: monospace;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 5px;
            border-radius: 3px;
            word-break: break-all;
        }
        .issue-details p {
            margin: 0;
        }
        .issue-details pre {
            display: inline;
            margin: 0;
            padding: 0;
            font-family: inherit;
            font-size: inherit;
            white-space: pre-wrap;
        }
        .progress-container {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 5px;
            margin-top: 20px;
        }
        .progress-bar {
            width: 0;
            height: 30px;
            background-color: #4CAF50;
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        .progress-text {
            text-align: center;
            line-height: 30px;
            color: white;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Accessibility Scanner</h1>
    <form id="scanForm">
        <label for="urlInput">Enter URL to scan:</label>
        <input type="text" id="urlInput" required>
        <button type="submit">Scan</button>
    </form>
    <div id="results" class="hidden"></div>

    <script>
        (function() {
            function checkRequiredElements() {
                const elements = {
                    scanForm: document.getElementById('scanForm'),
                    urlInput: document.getElementById('urlInput'),
                    resultsDiv: document.getElementById('results')
                };

                const missingElements = Object.entries(elements)
                    .filter(([, element]) => !element)
                    .map(([name]) => name);

                if (missingElements.length > 0) {
                    console.error('Missing elements:', missingElements);
                    document.body.innerHTML += `<p style="color: red;">Error: Required page elements not found (${missingElements.join(', ')}). Please refresh the page or contact support.</p>`;
                    return null;
                }

                return elements;
            }

            function initScanner() {
                const elements = checkRequiredElements();
                if (!elements) return;

                const { scanForm, urlInput, resultsDiv } = elements;

                scanForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    let url = urlInput.value.trim();

                    url = preprocessUrl(url);

                    if (!isValidUrl(url)) {
                        showError('Invalid URL', 'Please enter a valid website address.');
                        return;
                    }

                    resultsDiv.classList.remove('hidden');  // Remove the 'hidden' class

                    resultsDiv.innerHTML = `
                        <h3>Scanning ${safeText(url)}...</h3>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-text">0%</div>
                            </div>
                        </div>
                    `;

                    const progressBar = resultsDiv.querySelector('.progress-bar');
                    const progressText = resultsDiv.querySelector('.progress-text');

                    let progress = 0;
                    const interval = setInterval(() => {
                        progress += 5;
                        if (progress > 90) {
                            clearInterval(interval);
                        }
                        progressBar.style.width = `${progress}%`;
                        progressText.textContent = `${progress}%`;
                    }, 500);

                    fetch(`http://localhost:3000/scan?url=${encodeURIComponent(url)}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            clearInterval(interval);
                            progressBar.style.width = '100%';
                            progressText.textContent = '100%';

                            setTimeout(() => {
                                displayResults(data, url);
                            }, 500);
                        })
                        .catch(error => {
                            clearInterval(interval);
                            console.error('Fetch error:', error);
                            showError('Scanning Error', `An error occurred while scanning the website: ${error.message}`);
                        });
                });
            }

            function preprocessUrl(url) {
                url = url.trim();
                if (!/^https?:\/\//i.test(url)) {
                    url = 'https://' + url;
                }
                return url.replace(/\/$/, '');
            }

            function isValidUrl(string) {
                try {
                    new URL(string);
                    return true;
                } catch (_) {
                    return false;  
                }
            }

            function displayResults(data, url) {
                const resultsDiv = document.getElementById('results');
                const issues = data.issues || [];
                const errors = issues.filter(issue => issue.type === 'error');
                const warnings = issues.filter(issue => issue.type === 'warning');
                const notices = issues.filter(issue => issue.type === 'notice');

                let html = `
                    <h2>Accessibility Report for "${safeText(url)}"</h2>
                    <p>Scan completed at: ${new Date().toLocaleString()}</p>
                    <div class="summary">
                        <div class="summary-item">
                            <span class="summary-count" style="color: #e74c3c;">${errors.length}</span>
                            <label class="toggle-switch">
                                <input type="checkbox" class="filter-checkbox" data-type="error" checked>
                                <span class="slider"></span>
                            </label>
                            <span>Errors</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-count" style="color: #f39c12;">${warnings.length}</span>
                            <label class="toggle-switch">
                                <input type="checkbox" class="filter-checkbox" data-type="warning" checked>
                                <span class="slider"></span>
                            </label>
                            <span>Warnings</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-count" style="color: #3498db;">${notices.length}</span>
                            <label class="toggle-switch">
                                <input type="checkbox" class="filter-checkbox" data-type="notice" checked>
                                <span class="slider"></span>
                            </label>
                            <span>Notices</span>
                        </div>
                    </div>
                    <div id="issues-container">
                `;

                issues.forEach(issue => {
                    const typeCapitalized = safeText(issue.type).charAt(0).toUpperCase() + safeText(issue.type).slice(1);
                    const wcagGuideline = issue.code || 'Not specified';
                    html += `
                        <div class="issue ${safeText(issue.type)}">
                            <div class="issue-title">${typeCapitalized}: ${safeText(issue.message)}</div>
                            <div class="issue-details">
                                <p><strong>WCAG Guideline:</strong> ${safeText(wcagGuideline)}</p>
                                <p><strong>Selector:</strong> ${safeText(issue.selector || 'Not specified')}</p>
                                <p><strong>Context:</strong> <pre>${safeText(issue.context || 'Not available')}</pre></p>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                resultsDiv.innerHTML = html;

                document.querySelectorAll('.filter-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', filterIssues);
                });
            }

            function filterIssues() {
                const checkedTypes = Array.from(document.querySelectorAll('.filter-checkbox:checked'))
                    .map(checkbox => checkbox.getAttribute('data-type'));
                
                document.querySelectorAll('#issues-container .issue').forEach(issue => {
                    if (checkedTypes.includes(issue.classList[1])) {
                        issue.style.display = '';
                    } else {
                        issue.style.display = 'none';
                    }
                });
            }

            function showError(title, message) {
                const resultsDiv = document.getElementById('results');
                resultsDiv.innerHTML = `
                    <div class="error-message">
                        <div class="error-title">${safeText(title)}</div>
                        <div class="error-details">${safeText(message)}</div>
                    </div>
                `;
            }

            function safeText(unsafe) {
                if (unsafe == null) return '';
                return String(unsafe)
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initScanner);
            } else {
                initScanner();
            }
        })();
    </script>
</body>
</html>